#!/bin/bash

inDir=$1
filExt=m4b

printf '%s\n' "${inDir}" | while IFS= read -r input
do
	# echo "${input}"
	declare -A tag
	# What trick this is:
	#  1. use ffprobe to extract all the tags
	#     in json-format
	#  2. use jq to get key=value line
	#  3. read that input a populate the
	#     tag array with that data
	#  Here we go, this is step 3 taking
	#  the input from step 2 which was retrieved
	#  using step 1.
	while IFS='=' read -r key value; do
			tag["$key"]="$value"
	done < <(
			ffprobe -v quiet -show_format -print_format json "$input" \
			| jq -r '.format.tags | to_entries[] | "\(.key)=\(.value)"'
	)

	# Get track info, get current and max track
	trackInfo=${tag[track]}
	curTrk=${trackInfo//\/*}
	maxTrk=${trackInfo//*\/}
	# For the filename the track no. should have
	# leading zeros (how much depends on the
	# highest track no.)
	read chap < <(printf "%0${#maxTrk}d\n" $curTrk)
	if [[ ${tag[title]} =~ "Madame le Commissaire" ]]; then
		#stitle=${tag[title]%:*} # Kapitel is redundant in MlC, it is in track
		stitle=${tag[title]%*:* Kapitel*}
	else
		if [ ${tag[album]} = "Kluftinger" ]; then
			stitle=${tag[title]/:*}
		else
			#stitle=${tag[title]}
			stitle=${tag[title]%*:* Kapitel*}
		fi
	fi
	dirnam=${stitle//$curTrk - /}
	ftitle=$dirnam
	stitle="${dirnam//Madame le Commissaire /MlC }"
	vstitle="${dirnam//Madame le Commissaire /MlC${tag[PART]} }"
	first=${vstitle%% *}
	last=${vstitle##* }
	[[ $first != "$last" ]] && dirnam="$first -- $last"||dirnam=${stitle}
	filnam="${chap}. Kapitel"
	declare -A mp3tag
	mp3tag[album]=$ftitle
	mp3tag[title]=$filnam
	mp3tag[track]=$curTrk
	set | grep mp3tag
	cat <<-EOI>/dev/null
	album:    ${tag[album]}
	title:    ${ftitle}
	subtitle: ${tag[SUBTITLE]}
	series:   ${tag[SERIES]}
	part:     ${tag[PART]}
	track:    $curTrk ($chap)
	file: "${dirnam}/${filnam}"
	EOI
	echo ${dirnam}/${filnam}
	echo "  ${mp3tag[album]}"
	echo "    ${mp3tag[title]}"
done
