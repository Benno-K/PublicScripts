#!/usr/bin/env bash

set -euo pipefail

dryRun=false

# Parse options
while [[ $# -gt 0 ]]; do
    case "$1" in
        -d|--dry-run)
            dryRun=true
            shift
            ;;
        *)
            break
            ;;
    esac
done

# Check arguments
if [[ $# -ne 2 ]]; then
    echo "Usage: split [-d|--dry-run] <min-per-subdir> <subdir-prefix>"
    exit 1
fi

minPerSubdir="$1"
subdirPrefix="$2"

# Convert minutes to seconds
maxDurationSeconds=$((minPerSubdir * 60))

currentIndex=1
currentDuration=0
currentSubdir="${subdirPrefix}-$(printf "%02d" "$currentIndex")"

# Create first subdirectory
$dryRun || mkdir -p "$currentSubdir"

# Loop over MP3 files sorted by name
for mp3File in *.mp3; do
    # Get duration in seconds
    fileDuration=$(ffprobe -v error \
        -show_entries format=duration \
        -of default=noprint_wrappers=1:nokey=1 \
        "$mp3File")

    fileDuration=${fileDuration%.*}

    # Create new subdirectory if limit would be exceeded
    if (( currentDuration + fileDuration > maxDurationSeconds )); then
        currentIndex=$((currentIndex + 1))
        currentDuration=0
	currentSubdir="${subdirPrefix}-$(printf "%02d" "$currentIndex")"
        $dryRun || mkdir -p "$currentSubdir"
    fi

    if $dryRun; then
        printf "[DRY-RUN] mv \"%s\" \"%s/\"\n" "$mp3File" "$currentSubdir"
    else
        mv "$mp3File" "$currentSubdir/"
    fi

    currentDuration=$((currentDuration + fileDuration))
done
