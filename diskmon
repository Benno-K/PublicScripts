#!/bin/bash

threshold=5
stateFile="$HOME/.$(basename "$0").state"
declare -A fsStates
declare -A fsDates
quiet=0
savedCmdLine=""
savedThreshold=""

while getopts "t:q" opt; do
  case $opt in
    t) threshold="$OPTARG" ;;
    q) quiet=1 ;;
    \?) echo "Bad option: -$OPTARG" >&2; exit 1 ;;
    :) echo "Option -$OPTARG needs arg." >&2; exit 1 ;;
  esac
done

shift $((OPTIND - 1))

getUsage() { df -P "$1" | awk 'NR==2 {print $5, $4, $3}'; }

loadState() {
  if [ -f "$stateFile" ]; then
    while IFS='=' read -r key value; do
      case "$key" in
        "savedThreshold") savedThreshold="$value" ;;
        "savedCmdLine") savedCmdLine="$value" ;;
        initial_percent_*)
          fsKey="${key#initial_percent_}"
          fsStates["$fsKey"]="${value%%|*}"
          fsDates["$fsKey"]="${value#*|}"
          ;;
      esac
    done < "$stateFile"
  fi
}

saveState() {
  rm -f "$stateFile"
  printf "savedThreshold=%s\n" "$threshold" >> "$stateFile"
  printf "savedCmdLine=%s\n" "$savedCmdLine" >> "$stateFile"
  for fs in "$@"; do
    safeFs=$(echo "$fs" | sed 's/[^a-zA-Z0-9_]/_/g')
    safeFs="FS_${safeFs}"
    percent="${fsStates["$safeFs"]}"
    dt="${fsDates["$safeFs"]}"
    [ -n "$percent" ] && [ -n "$dt" ] && \
      printf "initial_percent_%s=%s|%s\n" "$safeFs" "$percent" "$dt" >> "$stateFile"
  done
}

loadState

if [ $# -eq 0 ]; then
  if [ -n "$savedCmdLine" ]; then
    set -- $savedCmdLine
    [ -n "$savedThreshold" ] && threshold="$savedThreshold"
  else
    echo "Usage: $0 [-t threshold] [-q] fs1 fs2 ..."
    exit 1
  fi
else
  savedCmdLine="$*"
fi

for fs in "$@"; do
  safeFs=$(echo "$fs" | sed 's/[^a-zA-Z0-9_]/_/g')
  safeFs="FS_${safeFs}"

  usage=$(getUsage "$fs")
  percent=$(echo "$usage" | awk '{print substr($1, 1, length($1)-1)}')
  free=$(echo "$usage" | awk '{print $2}')
  used=$(echo "$usage" | awk '{print $3}')

  now=$(date +"%d.%m.%y/%H.%M")

  initialPercent="${fsStates["$safeFs"]:-0}"
  initialDate="${fsDates["$safeFs"]:-$now}"

  # Initial usage
  if [ "$initialPercent" = "0" ]; then
    echo "$fs:"
    echo " $percent% f:$free u:$used"
    echo " rec:$now trg:$now"
    updateState=1
  else
    if [ "$quiet" -eq 0 ]; then
      echo "$fs:"
      echo " now $percent% was $initialPercent% f:$free u:$used"
      echo " rec:$initialDate trg:$now"
    fi
    updateState=0
  fi

  diff=$((percent - initialPercent))
  absDiff=$((diff < 0 ? -diff : diff))

  # Threshold exceeded
  if ((absDiff > threshold)); then
    echo "$fs:"
    echo " $initialPercent%->$percent% thr:$threshold%"
    echo " f:$free u:$used"
    echo " rec:$initialDate trg:$now"
    updateState=1
  fi

  if [ "$updateState" -eq 1 ]; then
    fsStates["$safeFs"]="$percent"
    fsDates["$safeFs"]="$now"
  fi
done

saveState "$@"
