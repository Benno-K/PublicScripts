#!/bin/bash

threshold=5
stateFile="$HOME/.$(basename "$0").state"
declare -A fsStates
declare -A fsDates
quiet=0
savedCmdLine=""
savedThreshold=""

showHelp() {
  cat <<EOF 1>&2
Usage: $(basename "$0") [options] fs1 [fs2 ...]
Options:
  -t N       Set threshold percentage (default: 5)
  -q         Quiet mode (minimal output)
  -h, --help Show this help and exit

Without arguments, runs with saved filesystems and threshold.
Example:
  $(basename "$0") -t 10 /home /var
  $(basename "$0") -q
EOF
  exit 0
}

# Human-readable format function using awk
human_readable() {
  awk -v size="$1" '
    function hum(n) {
      split("B K M G T P", u)
      i = 1
      while (n >= 1024 && i < 6) {
        n /= 1024
        i++
      }
      return sprintf("%.1f%s", n, u[i])
    }
    BEGIN { print hum(size) }
  '
}

# Check for -h or --help before option parsing
for arg in "$@"; do
  case "$arg" in
    -h|--help)
      showHelp
      ;;
  esac
done

while getopts "t:q" opt; do
  case $opt in
    t) threshold="$OPTARG" ;;
    q) quiet=1 ;;
    \?) echo "Bad option: -$OPTARG" >&2; exit 1 ;;
    :) echo "Option -$OPTARG needs arg." >&2; exit 1 ;;
  esac
done

shift $((OPTIND - 1))

# Use stat to get usage, avoiding parsing df output
getUsage() {
  statout=$(stat -f --format="%a %b %S" "$1" 2>/dev/null)
  if [ $? -ne 0 ] || [ -z "$statout" ]; then
    echo "ERROR"
    return 1
  fi
  set -- $statout
  free_blocks=$1
  total_blocks=$2
  block_size=$3

  used_blocks=$((total_blocks - free_blocks))
  [ "$total_blocks" -eq 0 ] && percent=0 || percent=$(( (used_blocks * 100) / total_blocks ))

  free_bytes=$((free_blocks * block_size))
  used_bytes=$((used_blocks * block_size))

  # Output: percent free_bytes used_bytes
  echo "$percent $free_bytes $used_bytes"
}

loadState() {
  if [ -f "$stateFile" ]; then
    while IFS='=' read -r key value; do
      case "$key" in
        "savedThreshold") savedThreshold="$value" ;;
        "savedCmdLine") savedCmdLine="$value" ;;
        initial_percent_*)
          fsKey="${key#initial_percent_}"
          fsStates["$fsKey"]="${value%%|*}"
          fsDates["$fsKey"]="${value#*|}"
          ;;
      esac
    done < "$stateFile"
  fi
}

saveState() {
  rm -f "$stateFile"
  printf "savedThreshold=%s\n" "$threshold" >> "$stateFile"
  printf "savedCmdLine=%s\n" "$savedCmdLine" >> "$stateFile"
  for fs in "$@"; do
    safeFs=$(echo "$fs" | sed 's/[^a-zA-Z0-9_]/_/g')
    safeFs="FS_${safeFs}"
    percent="${fsStates["$safeFs"]}"
    dt="${fsDates["$safeFs"]}"
    [ -n "$percent" ] && [ -n "$dt" ] && \
      printf "initial_percent_%s=%s|%s\n" "$safeFs" "$percent" "$dt" >> "$stateFile"
  done
}

loadState

if [ $# -eq 0 ]; then
  if [ -n "$savedCmdLine" ]; then
    set -- $savedCmdLine
    [ -n "$savedThreshold" ] && threshold="$savedThreshold"
  else
    echo "Usage: $0 [-t threshold] [-q] fs1 fs2 ..." >&2
    exit 1
  fi
else
  savedCmdLine="$*"
fi

for fs in "$@"; do
  safeFs=$(echo "$fs" | sed 's/[^a-zA-Z0-9_]/_/g')
  safeFs="FS_${safeFs}"

  usage=$(getUsage "$fs")
  if [ "$usage" = "ERROR" ]; then
    echo "$fs: Could not stat filesystem or directory." >&2
    continue
  fi
  percent=$(echo "$usage" | awk '{print $1}')
  free=$(echo "$usage" | awk '{print $2}')
  used=$(echo "$usage" | awk '{print $3}')

  free_h=$(human_readable "$free")
  used_h=$(human_readable "$used")

  now=$(date +"%d.%m.%y/%H.%M")

  initialPercent="${fsStates["$safeFs"]:-0}"
  initialDate="${fsDates["$safeFs"]:-$now}"

  # Initial usage
  if [ "$initialPercent" = "0" ]; then
    echo "$fs:"
    echo " $percent% f:$free_h u:$used_h"
    echo " rec:$now trg:$now"
    updateState=1
  else
    if [ "$quiet" -eq 0 ]; then
      echo "$fs:"
      echo " now $percent% was $initialPercent% f:$free_h u:$used_h"
      echo " rec:$initialDate trg:$now"
    fi
    updateState=0
  fi

  diff=$((percent - initialPercent))
  absDiff=$((diff < 0 ? -diff : diff))

  # Threshold exceeded
  if ((absDiff > threshold)); then
    echo "$fs:"
    echo " $initialPercent%->$percent% thr:$threshold%"
    echo " f:$free_h u:$used_h"
    echo " rec:$initialDate trg:$now"
    updateState=1
  fi

  if [ "$updateState" -eq 1 ]; then
    fsStates["$safeFs"]="$percent"
    fsDates["$safeFs"]="$now"
  fi
done

saveState "$@"
