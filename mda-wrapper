#!/bin/bash
#
# SpamAssassin → Dovecot LDA
# Decides Inbox vs Junk
# No reinjection
# No Postfix filters
#
##
##


snd="$1"
usr="$2"
me=${0##*/} # POSIX-variant of $(basename $0)

tmp="$(mktemp /tmp/${me}.XXXXXX)" || exit 75

cleanup() {
  [ -e "$tmp" ] && rm -f "$tmp"
}
trap cleanup EXIT HUP INT TERM

#
# Run SpamAssassin client
# Preserve full message
#
ulimit -f 65536   # 32 MB
if ! /usr/bin/spamc > "$tmp"; then
  #
  # Fail open:
  # deliver to Inbox
  #
  exec /usr/lib/dovecot/dovecot-lda \
    -f "$snd" -d "$usr" < "$tmp"
fi

#
# Check spam header
# Exact match only
#
if grep -q '^X-Spam-Status:[[:space:]]*Yes' "$tmp"; then
  #
  # Spam → Junk folder
  #
  exec /usr/lib/dovecot/dovecot-lda \
		-m Junk \
    -f "$snd" -d "$usr" < "$tmp"
else
  #
  # Clean → Inbox
  #
  exec /usr/lib/dovecot/dovecot-lda \
    -f "$snd" -d "$usr" < "$tmp"
fi
